<!DOCTYPE html>
<html>

<head>
    <title>Edit Games</title>
    <link href="styles.css" rel="stylesheet" />
</head>

<body class="bodyForm" style="text-align: center;">
    <ul>
        <li><a href="home.html">Home</a></li>
        <!--My Games-->
        <li class="dropdown">
            <a href="javascript:void(0)" class="dropbtn">My Games</a>
            <div class="dropdown-content">
                <a href="myGames.html">View My Games</a>
                <a href="myAnalytics.html">View My Analytics</a>
            </div>
        </li>
        <!--Add A Game-->
        <li><a href="addGame.html">Add A Game</a></li>
        <!--Edit My Games-->
        <li>
            <a class="active" href="editGame.html">Edit My Games</a>
        </li>
        <li style="float:right"><a id="signOutButton" href="#">Sign Out</a></li>
    </ul>
    <h1>Edit Games:</h1>
    <button id="saveChangesButton" onclick="saveChanges()">Save Changes</button>
    <table id="gamesList">
        <tr>
            <th style="border-top: none; border-left: none;"></th>
            <th>Comment:</th>
            <th>Date (yyyy-mm-dd):</th>
            <th>Division (Age-Group):</th>
            <th>Gender:</th>
            <th>Referee Position:</th>
        </tr>
    </table>
    <footer>
        <a href="privacyPolicy.html">Privacy Policy</a><br />
        <a href="termsAndConditions.html">Terms and Conditions</a>
        <p>Copyright &copy; Ayman Studios 2019. All Rights Reserved.&trade;</p>
    </footer>
    <!--Firebase Links-->
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="/__/firebase/7.2.1/firebase-app.js"></script>
    <!-- TODO: Add SDKs for Firebase products that you want to use https://firebase.google.com/docs/web/setup#available-libraries -->
    <script src="/__/firebase/7.2.1/firebase-analytics.js"></script>
    <script src="/__/firebase/7.2.1/firebase-firestore.js"></script>
    <!-- Initialize Firebase -->
    <script src="/__/firebase/init.js"></script>
    <script src="loggedIn.js"></script>
    <script src="signOut.js"></script>
    <script>
        var db = firebase.firestore();
        var gamesList = document.querySelector("#gamesList");
        var gameNumber = 0;
        gamesReffed.forEach(function(gameObject) {
            var tr = document.createElement("tr");
            tr.setAttribute("gameNumber", gameNumber);
            gameNumber++;
            var deleteButton = document.createElement("span");
            deleteButton.classList.add("deleteButton");
            deleteButton.setAttribute("onclick", "deleteGame(this.parentElement.parentElement);");
            deleteButton.innerHTML = "&minus;";
            var tdDelete = document.createElement("td");
            tdDelete.appendChild(deleteButton);
            tr.appendChild(tdDelete);
            Object.values(gameObject).forEach(function(gameDetail) {
                var td = document.createElement("td");
                var makeContentEditableComment = false;
                var makeSelectDate = false;
                var makeSelectDivision = false;
                var makeSelectGender = false;
                var makeSelectPosition = false;
                var detail = "";
                var type = "";
                var value = "";
                switch (gameDetail) {
                    case "cr":
                        makeSelectPosition = true;
                        detail = "Center";
                        type = "position";
                        value = "cr";
                        break;
                    case "ar":
                        makeSelectPosition = true;
                        detail = "Assistant";
                        type = "position";
                        value = "ar";
                        break;
                    case "u8":
                        makeSelectDivision = true;
                        detail = "U-8";
                        type = "division";
                        value = "u8";
                        break;
                    case "u10":
                        makeSelectDivision = true;
                        detail = "U-10";
                        type = "division";
                        value = "u10";
                        break;
                    case "u12":
                        makeSelectDivision = true;
                        detail = "U-12";
                        type = "division";
                        value = "u12";
                        break;
                    case "u14":
                        makeSelectDivision = true;
                        detail = "U-14";
                        type = "division";
                        value = "u14";
                        break;
                    case "u16":
                        makeSelectDivision = true;
                        detail = "U-16";
                        type = "division";
                        value = "u16";
                        break;
                    case "boys":
                        makeSelectGender = true;
                        detail = "Boys";
                        type = "gender";
                        value = "boys";
                        break;
                    case "girls":
                        makeSelectGender = true;
                        detail = "Girls";
                        type = "gender";
                        value = "girls";
                        break;
                    default:
                        //console.log(new Date(gameDetail).toLocaleDateString('en', {year: "numeric", month: "numeric", day: "numeric"}));
                        if (gameDetail.length === 10 && !isNaN(new Date(gameDetail).getDate())) {
                            //Then This is a date
                            makeSelectDate = true;
                            type = "date";
                        } else if (gameDetail.length === 0 || gameDetail === "") {
                            makeSelectDate = true;
                            type = "date";
                        } else {
                            //Then by POE this is a comment
                            makeContentEditableComment = true;
                            type = "comment";
                        }
                        detail = gameDetail;
                }
                if (makeContentEditableComment === true) {
                    td.innerHTML = "<textarea name='comments'>" + detail + "</textarea>";
                } else if (makeSelectDate === true) {
                    td.innerHTML = "<input name='date' type='date' value='" + detail + "' />";
                } else if (makeSelectDivision === true) {
                    switch (value) {
                        case "u8":
                            td.innerHTML = "<select name='division'><option value='u8' selected>U-8</option><option value='u10'>U-10</option><option value='u12'>U-12</option><option value='u14'>U-14</option><option value='u16'>U-16</option></select>";
                            break;
                        case "u10":
                            td.innerHTML = "<select name='division'><option value='u8'>U-8</option><option value='u10' selected>U-10</option><option value='u12'>U-12</option><option value='u14'>U-14</option><option value='u16'>U-16</option></select>";
                            break;
                        case "u12":
                            td.innerHTML = "<select name='division'><option value='u8'>U-8</option><option value='u10'>U-10</option><option value='u12' selected>U-12</option><option value='u14'>U-14</option><option value='u16'>U-16</option></select>";
                            break;
                        case "u14":
                            td.innerHTML = "<select name='division'><option value='u8'>U-8</option><option value='u10'>U-10</option><option value='u12'>U-12</option><option value='u14' selected>U-14</option><option value='u16'>U-16</option></select>";
                            break;
                        case "u16":
                            td.innerHTML = "<select name='division'><option value='u8'>U-8</option><option value='u10'>U-10</option><option value='u12'>U-12</option><option value='u14'>U-14</option><option value='u16' selected>U-16</option></select>";
                            break;
                    }
                } else if (makeSelectGender === true) {
                    if (value === "boys") {
                        td.innerHTML = "<select name='gender'><option value='boys' selected>Boys</option><option value='girls'>Girls</option></select>";
                    } else if (value === "girls") {
                        td.innerHTML = "<select name='gender'><option value='boys'>Boys</option><option value='girls' selected>Girls</option></select>";
                    }
                } else if (makeSelectPosition === true) {
                    if (value === "cr") {
                        td.innerHTML = "<select name='position'><option value='cr' selected>Center</option><option value='ar'>Assistant</option></select>";
                    } else if (value === "ar") {
                        td.innerHTML = "<select name='position'><option value='cr'>Center</option><option value='ar' selected>Assistant</option></select>";
                    }
                }
                td.setAttribute("type", type);
                tr.appendChild(td);
            });
            gamesList.appendChild(tr);
        });

        function deleteGame(obj) {
            var ready = confirm("Are you sure you would like to delete this game from the database? There is no going back if you do.");
            if (ready) {
                var pos, gen, div, date, comment;
                comment = obj.cells[1].innerText;
                date = obj.cells[2].innerText;
                switch (obj.cells[3].innerText) {
                    case "U-8":
                        div = "u8";
                        break;
                    case "U-10":
                        div = "u10";
                        break;
                    case "U-12":
                        div = "u12";
                        break;
                    case "U-14":
                        div = "u14";
                        break;
                    case "U-16":
                        div = "u16";
                        break;
                }
                gen = obj.cells[4].innerText.toLowerCase();
                switch (obj.cells[5].innerText) {
                    case "Center":
                        pos = "cr";
                        break;
                    case "Assistant":
                        pos = "ar";
                        break;
                }
                var indexOfGameToBeDeleted = gamesReffed.findIndex(findGameWhereDetailsMatch);

                function findGameWhereDetailsMatch(game) {
                    var bool;
                    if (game.position === pos && game.gender === gen && game.division === div && game.comments === comment) {
                        bool = true;
                    } else {
                        bool = false;
                    }
                    return bool;
                }
                if (indexOfGameToBeDeleted > -1) {
                    gamesReffed.splice(indexOfGameToBeDeleted, 1);
                    db.collection("users").doc(username).update({
                        "gamesReffed": gamesReffed
                    }).then(function() {
                        updateUser();
                        alert("Your game has been successfully been deleted.");
                    });
                }
                for (var j = 5; j > -1; j--) {
                    obj.deleteCell(j);
                }
            }
        }

        function saveChanges() {
            var newGamesList = [];
            var TRs = gamesList.querySelectorAll("tr");
            for (var c = 1; c < TRs.length; c++) {
                var TDs = TRs[c].querySelectorAll("td");
                var comments = "";
                var date = "";
                var division = "";
                var gender = "";
                var position = "";
                for (var d = 1; d < TDs.length; d++) {
                    var name = TDs[d].children[0].getAttribute("name");
                    switch (name) {
                        case "comments":
                            comments = TDs[d].children[0].value;
                            alert(comments);
                            comments.replace(/javascript|document|<|>|script|alert|[?=]|window|var|request/gi, / /);

                            function sanitizeString(str) {
                                var div = document.createElement('div');
                                div.textContent = str;
                                return div.innerText;
                            }
                            comments = (comments === "") ? "N/A" : comments;
                            comments = sanitizeString(comments);
                            //console.log(comments);
                            break;
                        case "date":
                            date = TDs[d].children[0].value;
                            //console.log(date);
                            break;
                        case "division":
                            division = TDs[d].children[0].value;
                            //console.log(division);
                            break;
                        case "gender":
                            gender = TDs[d].children[0].value;
                            //console.log(gender);
                            break;
                        case "position":
                            position = TDs[d].children[0].value;
                            //console.log(position);
                            break;
                    }
                }
                newGamesList.push({
                    position: position,
                    division: division,
                    gender: gender,
                    date: date,
                    comments: String(comments)
                });

            }
            /*console.log(newGamesList == gamesReffed);
            newGamesList.forEach(function(el) {
                console.log(el);
            });*/
            db.collection("users").doc(username).update({
                "gamesReffed": newGamesList
            }).then(function() {
                updateUser();
                window.location.reload();
            });
        }
    </script>
</body>

</html>